pipeline {
    agent any

    options {
        skipDefaultCheckout(true)
    }

    environment {
        DOCKER_BUILD_DIR = "C:\\docker-builds\\eParts_backend"
    }

    stages {

        stage('Checkout') {
            steps {
                checkout scm
            }
        }

        stage('Prepare Docker Directory') {
            steps {
                bat '''
                echo Preparing Docker build directory...

                if exist "%DOCKER_BUILD_DIR%" rmdir /s /q "%DOCKER_BUILD_DIR%"
                mkdir "%DOCKER_BUILD_DIR%"

                xcopy "%WORKSPACE%\\*" "%DOCKER_BUILD_DIR%\\" /E /I /Y

                echo Source copied to Docker build directory
                '''
            }
        }

        stage('Docker Build & Run') {
            steps {
                bat '''
                cd "%DOCKER_BUILD_DIR%"
                docker-compose down
                docker-compose build
                docker-compose up -d
                docker ps
                '''
            }
        }
    }

    post {
        success { echo "✅ Deployment Successful" }
        failure { echo "❌ Deployment Failed" }
    }
}
